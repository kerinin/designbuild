<% content_for :wrapping_form do %>
	<%= form_for [@parent, @markup], :remote => true do |f|  %>
		<% content_for :tr do %>
			<%= render :partial => 'form_tr', :locals => {:f => f, :redirect_to => get_redirect} %>
			
      <% case %>
      <% when params.has_key?( :project_id ) %>
        <%=f.fields_for :markings do |marking_form| %>
          <%=marking_form.hidden_field :markupable_id, :value => params[:project_id] %>
          <%=marking_form.hidden_field :markupable_type, :value => 'Project' %>
        <% end %>
      <% when params.has_key?( :component_id ) %>
        <%=f.fields_for :markings do |marking_form| %>
          <%=marking_form.hidden_field :markupable_id, :value => params[:component_id] %>
          <%=marking_form.hidden_field :markupable_type, :value => 'Component' %>
        <% end %>
      <% when params.has_key?( :contract_id ) %>
        <%=f.fields_for :markings do |marking_form| %>
          <%=marking_form.hidden_field :markupable_id, :value => params[:contract_id] %>
          <%=marking_form.hidden_field :markupable_type, :value => 'Contract' %>
        <% end %>
      <% when params.has_key?( :task_id ) %>
        <%=f.fields_for :markings do |marking_form| %>
          <%=marking_form.hidden_field :markupable_id, :value => params[:task_id] %>
          <%=marking_form.hidden_field :markupable_type, :value => 'Task' %>
        <% end %>
      <% end %>
		<% end %>
	<% end %>
<% end %>

<% content_for :cancel_link do %>
  <%= link_to( 'Cancel', get_redirect || markups_path ) %>
<% end %>

form = $("<%= escape_javascript( yield :wrapping_form) %>")
contents = form.children().detach();

$("table.totals").wrap(form).append(contents);
$("table.totals td.add_button").closest('tr').before("<%= escape_javascript( yield :tr ) %>");
$("table.totals tr.markup_fields > td.control").append("or <%= escape_javascript yield :cancel_link %>")
$("table.totals td.add_button").hide();
$("table.totals td.control.edit > a").contents().unwrap();
$("input:text:visible:first").focus();
